# 第4课：结构化输出

在本章中，您将学习：

- 什么是_结构化输出_以及如何有效地利用它。
- 如何从提示中提取信息并将其纳入输出。
- 生成不同类型的输出格式，如JSON，以便服务轻松使用。

## 设置

如果您尚未设置开发环境，请按照以下方法进行设置：[设置您的环境](/docs/setup/README.md)。

## 相关资源

值得重新观看关于提示工程的视频，因为它为您即将在本章学习的内容奠定了基础。

[![观看关于提示工程的短视频](https://img.youtube.com/vi/gQ6TlyxBmWs/0.jpg)](https://www.youtube.com/watch?v=gQ6TlyxBmWs&list=PLlrxD0HtieHi5ZpsHULPLxm839IrhmeDk&index=3)

_这个视频介绍了如何提高您的"提示"技能，教您如何向AI提供更清晰、更有效的指令以获得更好的结果。_

*🎥 点击上方图片观看关于提示工程的短视频*

💼 幻灯片：[提示工程](../../../videos/slides/02-prompt-engineering.pptx)

## 故事情节 - 跳出油锅，掉进火坑

> [!NOTE]
> _我们的故事到目前为止：您是一位来自1860年的机械工程师，正与达芬奇一起穿越时空。您已经逃脱了罗马士兵的追捕——或者说，您正在逃脱——并且正在拼命寻找一种安全降落空中螺旋机的方法_。
>
> 如果您想从头开始了解故事，请参阅[第1课](../../01-intro-to-genai/README.md)。

> [!NOTE]
> 虽然我们建议您阅读故事（很有趣！），但如果您想直接跳到技术内容，[请点击这里](#interact-with-montezuma)。

风在您和达芬奇乘坐的空中螺旋机周围呼啸，木制框架在压力下嘎吱作响。

**您：**"达芬奇，我们需要找到一条出路！"您在风的咆哮声中喊道。

**达芬奇：**"我对我的发明有信心，但我们需要的不仅仅是信心来逃脱这些士兵。"

**您：**"这可能是我们唯一的机会，"您按下甲虫的复杂机制。一道明亮的光芒笼罩着你们两个，周围的世界开始扭曲变形。

### 阿兹特克帝国

时间甲虫发出的明亮光芒逐渐消失，您发现自己站在一座巨大的石头金字塔基座处。环顾四周，您意识到自己已经来到了阿兹特克帝国的中心。

空中螺旋机尴尬地停在一块雕刻精美的大石头上，上面有看起来像日历的标记

<div>
  <img alt="阿兹特克日历，维基百科" src="../assets/aztec.png" width="300" />
</div>

_阿兹特克日历，维基百科_
 
达芬奇向前走了一步，眼中充满惊奇。

**达芬奇：**"难以置信，"他喃喃自语，手指抚过雕刻。"但我希望这不是什么重要的东西。"

在您做出反应之前，一群阿兹特克士兵走了过来。

<div>
  <img src="../assets/meeting.png" alt="与阿兹特克人会面" width="300" />
</div> 

**士兵领袖：**"你们是谁，做了什么？"他用纳瓦特尔语质问道。

您深吸一口气，试图稳定自己的神经。

**您：**"我们是来自遥远土地的旅行者，"您开始说道，希望您对古代语言的了解能派上用场。"这是一台飞行机器，是神明赐予我们的礼物，帮助我们到达你们这里。

战士的眼睛因惊讶而睁大，但他仍然保持警惕。

**士兵领袖：**"你们将跟我们一起去见统治者蒙特祖马。他将决定你们的命运。

到达金字塔顶部后，您被带入一个宏伟的大厅，阿兹特克帝国的统治者蒙特祖马坐在一个装饰着金子和羽毛的王座上。

**蒙特祖马：**"你们声称是来自遥远土地的旅行者，"蒙特祖马说道，他的声音平静但充满权威。"而且你们损坏了我们的神圣日历。你们打算如何弥补？"

## 让我们玩个游戏

**达芬奇：**"我们是和平而来，"他说，声音稳定。"我们寻求知识和理解。请允许我们展示我们机器的力量，并与您分享我们的知识。"

**蒙特祖马：**"很好。我提议玩一场[帕托利](#patolli)游戏。如果我赢得三局中的大多数，你们将把你们的设备给我并告诉我它是如何工作的。如果你们赢了，你们可以自由离开。"

<div>
  <img src="../assets/game.png" alt="玩帕托利游戏" width="300" />
</div>

游戏开始了，房间里一片寂静，只有豆子滚动和棋子在棋盘上移动的声音。

蒙特祖马赢得了第一局，他的技巧和经验显而易见。达芬奇仔细研究棋盘，他的思维在策略和概率中运转。

第二局是一场激烈的比赛，但达芬奇设法取得了胜利，使比分持平。

**达芬奇：**"还有一局，"他低声说道，"乔治（时间甲虫），我们需要赢得这一局，给我正确的走法。"

**时间甲虫：**好的，计算中...给你...

随着最后一步决定性的走法，达芬奇赢得了比赛。房间里爆发出欢呼和掌声，阿兹特克人显然对他的技巧和镇定印象深刻。蒙特祖马虽然失望，但点头表示尊重。

**蒙特祖马：**"你们公平地赢了，"蒙特祖马说，他的声音带着一丝钦佩。"你们可以自由离开，并且可以保留你们的设备。但请知道，如果你们希望回来，随时欢迎。"

**时间甲虫：**如果你不说，我也不会说，达芬奇 ;)

### 帕托利

> [!NOTE]
> 帕托利是美洲已知最古老的游戏之一，由前哥伦布时期的中美洲文化如阿兹特克人玩。它是策略和运气的结合。
>
> **帕托利的玩法**：
> - **棋盘和棋子**：在X形棋盘上玩，有一个中心块和四个臂。玩家使用五个黑豆作为骰子，一面有标记。
> - **设置**：每个玩家选择六个他们颜色的标记（珠子）并将它们放在棋盘外，加上用于计分的点珠。
> - **游戏玩法**：掷豆子使标记在棋盘上移动并回到起点。掷出五点移动十个空格。落在某些空格上可以获得回合，失去点数或捕获标记。
>
> **阿兹特克人的参与**：贵族和平民广泛玩这个游戏，它是蒙特祖马宫廷的最爱。除了娱乐外，它还涉及高风险赌博，赌注如毯子、宝石甚至自由。

<div>
  <img width="300" src="../assets/patolli.png" alt="帕托利棋盘" />
</div>

_帕托利 - 维基百科_

## 与蒙特祖马互动

如果您想与蒙特祖马互动，请运行[角色](/app/README.md)应用程序。

> [!IMPORTANT]
> 这完全是虚构的；响应由AI生成。
> [负责任的AI免责声明](../../../README.md#responsible-ai-disclaimer)

<div>
  <img src="../assets/montezuma.jpeg" alt="蒙特祖马" width="300" />
</div>

**步骤**：

1. 启动一个[![GitHub Codespace](https://img.shields.io/badge/GitHub-Codespace-brightgreen)](https://codespaces.new/microsoft/generative-ai-with-javascript)
2. 导航到仓库根目录中的_/app_。
3. 找到控制台并运行`npm install`，然后运行`npm start`。
4. 出现后，选择"在浏览器中打开"按钮。
5. 与蒙特祖马聊天。

有关应用的更详细解释，请参阅[详细应用解释](../../01-intro-to-genai/README.md#interact-with-dinocrates)。

> [!NOTE]
> 如果您在本地机器上运行项目，请查看快速入门指南，设置[GitHub个人访问令牌](../../../docs/setup/README.md#creating-a-personal-access-token-pat-for-github-model-access)并替换代码中的密钥。

## 结构化输出

**时间甲虫：**想知道我是如何打败蒙特祖马的吗？

**您：**嘘，小声点，我们还在阿兹特克帝国。

**时间甲虫：**哦，对不起，是的，所以结构化输出就是我的方法。你要求正确的走法，我以结构化的方式给你提供了它们。

结构化输出使用特定的数据格式来清晰地组织信息。常见的格式如JSON、XML和CSV使服务更容易处理和使用数据。

生成式AI模型可以输出各种格式的数据。然而，非结构化文本的输出可能使提取信息并将其传递给其他服务变得困难。结构化输出可以在这方面提供帮助。

**您：**嗯，你真聪明 ;)

**时间甲虫：**我尽力而为。:-)

另一个好处是，即使对于人类读者来说，当结构化数据遵循熟悉的格式时，也更容易阅读和理解。

让我们看一些输入示例，看看如何通过要求特定的输出格式来帮助提取信息，使其更容易理解和使用。

**您：**好吧，反正我们也没有其他计划，让我们听听。

## 塑造输出

**时间甲虫：**让我们从一个简单的例子开始。想象一下，您是达芬奇，正在尝试使用15世纪的技术构思发明创意。您想知道需要什么资源以及建造每个发明需要多少努力。以下是您可以如何询问这些信息：

**达芬奇：**哦，我喜欢这个游戏，每个人都假装你是我！

> 提示：生成我可以使用15世纪技术建造的发明创意。对于每个发明，指定所需的资源并估计建造它所需的努力。

```text
结果：
当然！以下是一些您可以使用15世纪技术建造的详细发明创意，以及所需的资源和涉及的努力：

### 1. 水力磨坊
**所需资源**：
 - 水源（河流或溪流）
 - 水轮和磨坊结构的木材
 - 用于研磨的石头
 - 用于齿轮和轴的金属

 **努力**：
 - **高**：需要重要的建筑和工程技能来建造水轮、磨坊结构和研磨机制。确保持续的水流。

### 2. 星盘
**所需资源**：
 - 黄铜或其他金属
 - 雕刻工具
 - 数学知识

**努力**：
 - **中等**：涉及精确的金属加工和雕刻。需要天文学和数学知识以确保准确性。

### 3. 印刷机
**所需资源**：
 - 用于印刷机结构的木材
 - 用于活字的金属
 - 墨水和纸张

**努力**：
 - **高**：建造印刷机和制作活字需要高级木工和金属加工技能。排版和印刷也需要细致的工作。

这是一个看起来不错的响应，每个创意都以相同的方式构建，很容易理解。但如果你想要其他方式呢？为此，你可以在文本中指示你想要的方式，甚至可以提供输出模板。让我们展示每种技巧。
```

**达芬奇：**是的，完全要偷那个水力磨坊的想法，我现在就能看到，一个在河边的磨坊，把谷物磨成面粉，太完美了！我喜欢这个小玩意。小玩意，我还在想什么？这将使我不那么依赖斯福尔扎这样的人。

**时间甲虫：**当然，如果你能完成一个项目的话，达芬奇。:-)

**达芬奇：**嘿，我正在努力！

**时间甲虫：**让我们看看如何指导模型以更结构化的方式呈现输出。

### 构建更好输出的提示

**时间甲虫：**你可以通过告诉模型你想要如何构建输出来改进你的提示。例如，你可以要求一个带有你需要的列的表格格式。以下是如何修改提示：

> 提示：生成可以使用15世纪技术建造的发明创意。对于每个发明，提供所需的资源并估计建造它所需的努力。以下列列的表格形式呈现信息：标题、描述、所需资源和努力。

```text
结果：

| 标题 | 描述 | 所需资源 | 努力 |
|------|------|----------|--------|
| 水力磨坊 | 一个由水轮驱动的磨坊，将谷物磨成面粉。| 水源、木材、石头、用于齿轮和轴的金属 | 高 |
| 星盘 | 一个用于解决与时间和星位相关问题的天文仪器。| 黄铜或其他金属、雕刻工具、数学知识 | 中等 |
| 印刷机 | 一个比手工抄写更有效地复制文本的印刷机。| 木材、用于活字的金属、墨水、纸张 | 高 |

这次你得到了一个更容易阅读和理解的表格。
```

**达芬奇：**我喜欢这个，肯定会为我节省很多时间。

**您：**我也是。

### 提供输出模板

获取结构化输出的另一种方式是提供输出模板。它可以是任何格式，从列到JSON、XML、CSV或markdown。

> 提示：生成可以使用15世纪技术建造的发明创意。对于每个发明，指定所需的资源并估计建造它所需的努力。使用以下格式呈现信息（使用markdown作为输出格式）：
> 
> 标题：[发明名称]
> 描述：[简短说明]
> 所需资源：[所需材料列表]
> 努力：[估计的难度或所需劳动]

```text

**结果**：

当然！以下是一些您可以使用15世纪技术建造的发明创意，按照要求的格式呈现：

### 1. 水力磨坊
**标题**：水力磨坊

**描述**：一个由水轮驱动的磨坊，将谷物磨成面粉。

**所需资源**：水源、木材、石头、用于齿轮和轴的金属。

**努力**：高 - 需要重要的建筑和工程技能来建造水轮、磨坊结构和研磨机制。确保持续的水流也是必要的。

### 2. 星盘
**标题**：星盘

**描述**：一个用于解决与时间和星位相关问题的天文仪器。

**所需资源**：黄铜或其他金属、雕刻工具、数学知识。

**努力**：中等 - 涉及精确的金属加工和雕刻。需要天文学和数学知识以确保准确性。

### 3. 印刷机
**标题**：印刷机

**描述**：一个比手工抄写更有效地复制文本的印刷机。

**所需资源**：木材、用于活字的金属、墨水、纸张。

**努力**：高 - 建造印刷机和制作活字需要高级木工和金属加工技能。排版和印刷也需要细致的工作。

### 4. 机械钟
**标题**：机械钟

**描述**：一个使用齿轮和砝码来计时的钟。

**所需资源**：用于齿轮、弹簧、砝码的金属，用于外壳的木材，精密工具。

**努力**：非常高 - 需要精密的金属加工和对机械的深入理解。建造一个可靠的钟需要精确的组装和校准。
```

**达芬奇：**这很棒，但谁是Jason？

**时间甲虫：**JSON，达芬奇，JSON。它是一种易于被服务或应用程序使用的结构化格式。

**达芬奇：**这就是我说的，Jason。

**时间甲虫：**_叹气_。

如你所见，输出是按照输出模板中的规范构建的。这使其更容易阅读和理解，它还创建了可以被其他服务或应用程序轻松使用的可重复输出。

当然，服务更受益于更结构化的输出，如JSON、XML或CSV，所以让我们看看如何请求这些格式。

### 使用JSON、XML或CSV等结构化输出格式

**时间甲虫：**到目前为止，你已经看到了如何通过在提示中指导模型来控制输出结构。你甚至提供了一个输出模板。让我们更进一步，看看如何将这个想法应用到更结构化的输出格式，如JSON等。

相应地修改提示以请求JSON输出：

> **提示**：生成我可以使用15世纪技术建造的发明创意，请让我知道每个发明需要什么资源以及建造每个发明需要多少努力，对于每个创意以json格式呈现，包括标题、描述、所需资源、努力的属性
> 
> JSON输出示例：
> [
>   {
>     "title": "",
>     "description": ".",
>     "resources_needed": "",
>     "effort": ""
>   }
> ]

```json
[
  {
    "title": "水力磨坊",
    "description": "一个由水轮驱动的磨坊，将谷物磨成面粉。",
    "resources_needed": "水源、木材、石头、用于齿轮和轴的金属",
    "effort": "高 - 需要重要的建筑和工程技能来建造水轮、磨坊结构和研磨机制。确保持续的水流也是必要的。"
  },
  {
    "title": "星盘",
    "description": "一个用于解决与时间和星位相关问题的天文仪器。",
    "resources_needed": "黄铜或其他金属、雕刻工具、数学知识",
    "effort": "中等 - 涉及精确的金属加工和雕刻。需要天文学和数学知识以确保准确性。"
  },
  {
    "title": "印刷机",
    "description": "一个比手工抄写更有效地复制文本的印刷机。",
    "resources_needed": "木材、用于活字的金属、墨水、纸张",
    "effort": "高 - 建造印刷机和制作活字需要高级木工和金属加工技能。排版和印刷也需要细致的工作。"
  },
  {
    "title": "机械钟",
    "description": "一个使用齿轮和砝码来计时的钟。",
    "resources_needed": "用于齿轮、弹簧、砝码的金属，用于外壳的木材，精密工具",
    "effort": "非常高 - 需要精密的金属加工和对机械的深入理解。建造一个可靠的钟需要精确的组装和校准。"
  },
  {
    "title": "风车",
    "description": "一个由风力驱动的磨坊，用于磨谷物或抽水。",
    "resources_needed": "木材、用于齿轮和轴的金属、用于基座的石头",
    "effort": "高 - 建造风车需要重要的木工和工程技能。你需要设计和建造叶片、塔架和内部机制。"
  },
  {
    "title": "浑仪",
    "description": "一个用环表示大圆的天球模型。",
    "resources_needed": "用于环和支架的金属、弯曲和连接金属的工具、天文学知识",
    "effort": "中等 - 涉及精确的金属加工和组装。需要理解天体运动以准确定位环。"
  },
  {
    "title": "攻城机（投石机或弩炮）",
    "description": "一个用于演示力学和物理原理的投石机或弩炮。",
    "resources_needed": "木材、绳索、用于轴和配重的金属",
    "effort": "中等到高 - 建造一个功能性的攻城机需要木工技能和对力学的理解。测试和调整以获得最佳性能可能很耗时。"
  },
  {
    "title": "蒸馏装置",
    "description": "一个通过蒸馏净化液体的装置。",
    "resources_needed": "用于烧瓶和冷凝器的玻璃或金属、热源、管道",
    "effort": "中等 - 需要基本的吹玻璃或金属加工技能。设置和维持正确的蒸馏温度需要仔细监控。"
  },
  {
    "title": "指南针",
    "description": "一个用于导航的磁罗盘。",
    "resources_needed": "磁化针、非磁性外壳、用于阻尼的水或油",
    "effort": "低 - 制作指南针相对简单。主要挑战是磁化针并确保它平衡且能自由旋转。"
  },
  {
    "title": "输水渠",
    "description": "一个使用重力输送水的系统。",
    "resources_needed": "石头或砖块、砂浆、切割和塑形石头的工具",
    "effort": "非常高 - 建造输水渠涉及大量的建筑工作和工程。确保水流的一致坡度需要精确的规划和执行。"
  }
]
```

**时间甲虫：**这种类型的结构化输出可以发送给另一个可以使用JSON数据的服务或应用程序。

## 从提示中提取数据

**时间甲虫：**想象一下你正在构建一个聊天机器人，帮助用户找到有关预订旅行的信息。你想从用户的输入中提取关键细节以提供相关响应。假设你有以下描述：

> 输入你想去的地方、何时旅行以及你的预算。

提取信息的提示是什么样的？

> 提示：从用户的提示中提取以下信息：地点、时间、预算、货币，以JSON格式响应提取的数据。
>
> 用户提示：我想在六月去希腊，我的预算是800欧元。

> 响应：

```json
{
  "location": "希腊",
  "when": "六月",
  "budget": 800,
  "currency": "欧元"
}
```

**达芬奇：**乔治（时间甲虫）他一直不停地说话，是吗？

**您：**让我们看看能不能找到关闭开关。

**时间甲虫：**让我们用类似的提示试试，让我们稍微改变一下用户输入，这样我们就能确保模型在做正确的事情。

> 提示：从用户的提示中提取以下信息：地点、时间、预算、货币。以JSON格式响应提取的数据。用户提示：去美国，最多1200美元，可能是一月。
>
> 响应：

```json
{
  "location": "美国",
  "when": "一月",
  "budget": 1200,
  "currency": "美元"
}
```

作为开发者，你可以创建一个模板：

```text
从用户的提示中提取以下信息：地点、时间、预算、货币，以JSON格式响应提取的数据，用户提示：{user_input}。
```

**您：**找到了，给你，乔治！

**时间甲虫：**_正在关机_。

**达芬奇：**终于安静了。

**时间甲虫：**_启动紧急启动_。我刚才说到哪里了？哦，对了。

**时间甲虫：**对于聊天机器人来说，这是一个非常强大的功能，因为它允许你从用户的输入中提取信息。如果用户询问各种事情怎么办？你可以创建一个模板，描述你的聊天机器人可以做什么以及需要什么参数。以下是你可以如何做到这一点：

```text
以下是你拥有的一些技能：

技能：预订旅行
参数：地点、时间、预算、货币

技能：查找酒店
参数：地点、入住日期、退房日期、预算

技能：订餐
参数：菜系、送餐地址、支付方式

根据用户的提示确定使用哪个技能并提取必要的参数，以JSON格式响应提取的数据，包括技能、参数、提取的数据列

{user_input}
```

让我们试试以下用户输入：

> 提示：去美国，最多1200美元，可能是一月。
> 结果：

```json
{
  "skill": "预订旅行",
  "parameters": ["地点", "时间", "预算", "货币"],
  "extracted_data": {
    "location": "美国",
    "when": "一月",
    "budget": 1200,
    "currency": "美元"
  }
}
```

> 提示：我想在纽约预订住宿
> 结果：

```json
{
  "skill": "查找酒店",
  "parameters": ["地点", "入住日期", "退房日期", "预算"],
  "extracted_data": {
    "location": "纽约",
    "check_in": null,
    "check_out": null,
    "budget": null
  }
}
```

这种结合呈现技能和参数并从提示中提取数据的组合也被称为_工具调用_或_函数调用_。来自模型的这种响应使你作为开发者很容易理解用户想要什么以及如何调用相应的函数来满足用户的请求。

**您：**非常有用的信息，乔治！

## 作业 - 修复空中螺旋机

**时间甲虫：**我需要你们两个的注意，我们有个问题。空中螺旋机在逃离罗马士兵和降落在阿兹特克帝国时受到了一些损坏。达芬奇的机器非常敏感，需要非常具体的输入来修复它。你需要向你的时间甲虫（AI助手）提供必要的信息来帮助你修复空中螺旋机。

**达芬奇：**所以我设法修复了空中螺旋机的损坏，但现在它需要一个启动序列：左、左、上、右。

**您：**听起来很简单，就是这些文字？

**达芬奇：**是的，但它很特别，需要镜像，这是我写所有文字的方式。当然，我还使用凯撒密码，偏移量为3，因为我是意大利人。:-)

**您：**是的，你能直接输入吗？

**达芬奇：**我可以，但我很好奇想看看你和时间甲虫能不能做到。

**您：**好吧。

**指示：**编写一个提示，要求空中螺旋机的启动序列，文本应该是镜像的，并用偏移量为3的凯撒密码编码。用编码后的文本响应。

查看[示例应用](../sample-app)以获取开始的代码。它包含一个带有所有必需依赖项的Node.js项目。

> 注意：如果你还没有创建Codespace，请现在创建，因为你需要它来让示例应用中的AI通信工作。
>
> 请参阅[设置您的环境](/docs/setup/README.md)文档中的_选项1：创建GitHub Codespace_部分。

## 解决方案

[解决方案](../solution/solution.md)

## 挑战

采用旅行预订的例子，提供技能和提取参数到你选择的领域。编写一个提示，要求用户输入，然后提取必要的信息来满足用户的请求。以JSON格式响应提取的数据，包括技能、参数和提取的数据列。

同时根据用户的输入确定技能。

## 总结

在本章中，您学习了结构化输出以及如何使用它以结构化方式呈现信息。

您探索了不同的方式来塑造输出，包括在提示中指导模型、提供输出模板以及使用JSON、XML或CSV等格式。

此外，您还学习了如何从提示中提取数据并以结构化格式呈现。

通过有效利用结构化输出，您可以使生成式AI模型生成的信息更容易理解和使用。

## 知识检查

**问题**：结构化输出用于什么？选择所有适用项。

A. 以结构化方式呈现信息。

B. 从提示中提取数据。

C. 生成非结构化文本。

[测验解决方案](../solution/solution-quiz.md)

## 自学资源

- [使用JavaScript的生成式AI视频系列](https://aka.ms/genai-js)