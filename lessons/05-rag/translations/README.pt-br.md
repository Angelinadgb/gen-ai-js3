# Li√ß√£o 5: Converse com seus dados usando Gera√ß√£o Aumentada por Recupera√ß√£o (RAG)

Neste cap√≠tulo voc√™ vai aprender:

- Os fundamentos da Gera√ß√£o Aumentada por Recupera√ß√£o (RAG) e como ela pode ser usada para melhorar as respostas dos modelos de IA generativa.
- Como integrar fontes de dados externas em sua aplica√ß√£o de IA.
- Como aproveitar seus dados para melhorar a relev√¢ncia e precis√£o do conte√∫do gerado por IA.

## Configura√ß√£o

Se voc√™ ainda n√£o configurou seu ambiente de desenvolvimento, veja como fazer: [Configure seu ambiente](/docs/setup/README.md).

## Recursos relacionados

[![Assista a um v√≠deo curto sobre RAG](https://img.youtube.com/vi/xkFOmx5yxIA/0.jpg)](https://www.youtube.com/watch?v=xkFOmx5yxIA&list=PLlrxD0HtieHi5ZpsHULPLxm839IrhmeDk&index=4)

_Este v√≠deo explica a Gera√ß√£o Aumentada por Recupera√ß√£o (RAG), um m√©todo que ajuda a IA a usar seu conte√∫do junto com seus dados de treinamento para obter melhores resultados._

*üé• Clique na imagem acima para assistir a um v√≠deo curto sobre gera√ß√£o aumentada por recupera√ß√£o, RAG*

üíº Slides: [Gera√ß√£o aumentada por recupera√ß√£o, RAG](/videos/slides/03-rag.pptx)

## Narrativa - G√™nesis

> [!NOTE] 
> _Nossa hist√≥ria at√© agora. Voc√™ √© um mec√¢nico da Londres dos anos 1860. Voc√™ estava trabalhando em seu aut√¥mato e recebeu uma carta de Charles Babbage que acabou levando voc√™ a uma biblioteca onde voc√™ pegou um dispositivo de viagem no tempo. Durante suas viagens no tempo, voc√™ acabou em Floren√ßa, onde conheceu Leonardo Da Vinci. Voc√™ tamb√©m foi ao imp√©rio Asteca e √© aqui que a hist√≥ria continua._
>
> Veja a [Li√ß√£o 1](/lessons/01-intro-to-genai/README.md) se quiser acompanhar a hist√≥ria desde o in√≠cio. 

> [!NOTE] 
> Embora recomendemos seguir a hist√≥ria (√© divertido!), [clique aqui](#interaja-com-ada-lovelace) se preferir ir direto para o conte√∫do t√©cnico.

**Voc√™**: "Leonardo, √© hora de ir," voc√™ disse, pressionando o bot√£o. O dispositivo come√ßou a funcionar, e uma voz mec√¢nica ecoou: "√â hora de ir para casa, √© hora da 'g√™nese'."

**Leonardo:** "G√™nesis? Che cosa significa?" Leonardo perguntou, confuso. Antes que voc√™ pudesse responder, o mundo se dissolveu em um borr√£o de cores e sons, o templo desaparecendo enquanto voc√™s eram puxados atrav√©s do tempo.

Voc√™s pousam no jardim, √© tarde da noite com uma n√©voa espessa e luzes sinistras piscando √† dist√¢ncia. A mans√£o se ergue diante de voc√™s. Leonardo olha ao redor, seus olhos arregalados de admira√ß√£o.

<div>
  <img src="../assets/mansion.jpeg" alt="Antiga mans√£o mostrada em uma n√©voa densa" width="300">
</div>

### Fugindo dos C√£es

Voc√™ ouve latidos e o som de c√£es correndo em sua dire√ß√£o. Voc√™ se vira para Leonardo: "Precisamos entrar, agora!"

<div>
  <img src="../assets/dogs.jpeg" alt="Fugindo dos c√£es" width="300">
</div>

Quando voc√™ chega √† porta da mans√£o, ela se abre e um par de atendentes sai apressadamente. Depois de avali√°-los, eles fazem sinal para que voc√™s os sigam.

Voc√™ se encontra cara a cara com Ada Lovelace, seus olhos brilhando de curiosidade.

### Conhecendo Ada e Charles

**Ada:** "Ah, j√° era hora de chegarem," ela disse calorosamente. "Precisamos que voc√™s fa√ßam um servi√ßo."

**Voc√™:** "J√° era hora", voc√™s continuam dizendo isso. Din√≥crates disse o mesmo, mas n√£o tenho certeza do que quer dizer?

**Ada:** Sil√™ncio, n√£o h√° tempo para isso agora, precisamos falar sobre o dispositivo que voc√™ est√° segurando. Charles, explique a eles...

**Voc√™:** Mas...

<div>
  <img src="../assets/ada.jpeg" alt="Ada Lovelace e Charles Babbage trabalhando em um dispositivo" width="300">
</div>

Charles Babbage se aproxima, examinando o Besouro do Tempo em sua m√£o. "Este dispositivo √© not√°vel, mas est√° um pouco defeituoso, n√£o est√°? Voc√™ deve ter notado, tenho certeza."

Leonardo assentiu: "S√¨, tem se comportado de maneira estranha."

**Ada:** O dispositivo n√£o est√° totalmente pronto, precisamos dar a ele mais capacidades. Precisamos torn√°-lo mais inteligente, mais consciente do mundo ao seu redor. A ideia √© que ele seja capaz de recuperar informa√ß√µes de diferentes per√≠odos de tempo e us√°-las para gerar respostas precisas e relevantes. Pode nos ajudar com isso?

**Voc√™:** Claro, parece que precisamos _aumentar_ as respostas do dispositivo com dados, faz sentido.

**Ada:** Vamos falar sobre um conceito que eu gostaria de chamar de RAG, ou Gera√ß√£o Aumentada por Recupera√ß√£o.

## Interaja com Ada Lovelace

Se voc√™ quiser interagir com Ada, execute o aplicativo [Characters](/app/README.md). 

> [!IMPORTANT]
> Isso √© inteiramente fict√≠cio; as respostas s√£o geradas por IA.
> [Aviso sobre IA Respons√°vel](/README.md#responsible-ai-disclaimer)

<div>
  <img src="../assets/ada-2.jpeg" alt="Ada Lovelace" width="300">
</div>

**Passos**:

1. Inicie um [![GitHub Codespace](https://img.shields.io/badge/GitHub-Codespace-brightgreen)](https://codespaces.new/microsoft/generative-ai-with-javascript)
2. Navegue at√© _/app_ na raiz do reposit√≥rio.
3. Localize o console e execute `npm install` seguido de `npm start`.
4. Quando aparecer, selecione o bot√£o "Open in Browser".
5. Converse com Ada.

Para uma explica√ß√£o mais detalhada do aplicativo, consulte [Explica√ß√£o detalhada do aplicativo](/lessons/01-intro-to-genai/README.md#interact-with-dinocrates).

> [!NOTE]
 > Se voc√™ estiver executando o projeto localmente em sua m√°quina, por favor revise o guia de In√≠cio R√°pido para configurar um [token de acesso pessoal do GitHub](/docs/setup/README.md#creating-a-personal-access-token-pat-for-github-model-access) e substitua a chave no c√≥digo.

## Desafios conhecidos com grandes modelos de linguagem, LLMs

**Ada:** Vamos come√ßar discutindo a IA que usaremos para alimentar o dispositivo. Vamos confiar em "modelos de IA" emparelhados com um sistema de recupera√ß√£o de dados para melhorar a qualidade das respostas.

Primeiro, voc√™ precisa abordar alguns desafios antes de mergulhar nos detalhes do RAG. Esses modelos, treinados em vastos dados de texto, podem produzir respostas relevantes e corretas. Mas, como qualquer fonte de dados, sua sa√≠da pode ser imprecisa, incompleta ou enganosa devido a v√°rios fatores.

- **Fontes desatualizadas:** Os dados usados para treinar o modelo podem estar desatualizados e n√£o mais precisos.
- **Informa√ß√µes erradas ou imprecisas:** As fontes usadas para treinar o modelo podem conter informa√ß√µes incorretas ou enganosas, como not√≠cias falsas ou opini√µes tendenciosas.
- **Fontes n√£o autoritativas:** O modelo pode n√£o ser capaz de distinguir entre fontes autoritativas e n√£o autoritativas em seus dados de treinamento, levando a informa√ß√µes n√£o confi√°veis.

Isso torna dif√≠cil dizer se as informa√ß√µes geradas por um LLM est√£o corretas ou n√£o. √â aqui que o RAG entra.

**Voc√™:** Ent√£o eu preciso garantir que o dispositivo possa fornecer informa√ß√µes precisas, mesmo quando n√£o tem certeza sobre a resposta?

**Ada:** Sim, essa √© a ideia. Ao combinar os pontos fortes dos m√©todos baseados em recupera√ß√£o e dos modelos generativos, obtemos um sistema de IA melhor.

## Gera√ß√£o Aumentada por Recupera√ß√£o, conceitos fundamentais do RAG

**Ada:** Ah sim, hora de discutir especificamente o RAG. Vamos come√ßar com alguns fundamentos:

Gera√ß√£o Aumentada por Recupera√ß√£o (RAG) √© uma t√©cnica poderosa que combina os pontos fortes de duas abordagens diferentes no processamento de linguagem natural: m√©todos baseados em recupera√ß√£o e modelos generativos. Essa abordagem h√≠brida permite a gera√ß√£o de respostas que s√£o contextualmente relevantes e ricas em conte√∫do, para ajudar a aliviar alguns dos desafios conhecidos com os LLMs.

Em sua ess√™ncia, o RAG envolve dois componentes principais: um **recuperador** e um **gerador**.

- **O recuperador:** √© respons√°vel por encontrar informa√ß√µes relevantes de fontes de dados externas que podem ser usadas para melhorar as respostas geradas por IA, como um mecanismo de busca. Essas informa√ß√µes podem estar na forma de texto, imagens ou qualquer outro tipo de dados relevantes para o contexto da conversa, embora o texto seja o tipo de dados mais comum utilizado.

- **O gerador:** toma as informa√ß√µes recuperadas e as usa para gerar uma resposta contextualmente relevante e informativa.

Aqui est√° um esquema ilustrando como um sistema RAG funciona:

![Esquema de um sistema RAG](../assets/rag.png)

1. **Entrada do usu√°rio:** O usu√°rio faz uma pergunta.
2. **Recuperador:** O componente recuperador busca informa√ß√µes relevantes usando uma ou mais bases de conhecimento.
3. **Prompt aumentado:** As informa√ß√µes recuperadas s√£o combinadas com a pergunta do usu√°rio e o contexto, para criar um prompt aumentado.
4. **Gerador:** O LLM usa o prompt aumentado para gerar uma resposta.

Essa combina√ß√£o permite respostas mais precisas e relevantes, usando dados que voc√™ fornece em vez de depender dos dados de treinamento do modelo.

**Ada:** Perguntas?

**Voc√™:** Ent√£o o recuperador encontra as informa√ß√µes e o gerador as usa para gerar uma resposta?

**Ada:** Exatamente, voc√™ est√° pegando o jeito.

## Integrando fontes de dados externas

**Ada:** Agora que cobrimos os fundamentos do RAG, vamos falar sobre como voc√™ pode integrar fontes de dados externas em sua aplica√ß√£o de IA.

A integra√ß√£o de fontes de dados externas em sua aplica√ß√£o de IA pode ser feita de v√°rias maneiras, dependendo do tipo de dados que voc√™ deseja usar e da complexidade do mecanismo de recupera√ß√£o. Aqui est√£o alguns m√©todos comuns:

- **APIs:** Muitas fontes de dados externas fornecem APIs que permitem acessar seus dados programaticamente. Voc√™ pode usar essas APIs para recuperar informa√ß√µes em tempo real e us√°-las para melhorar as respostas geradas por IA.

- **Bancos de dados:** Se voc√™ tem uma grande quantidade de dados que deseja usar para recupera√ß√£o, pode armazen√°-los em um banco de dados e consult√°-los conforme necess√°rio. Isso pode ser √∫til para dados estruturados que precisam ser acessados rapidamente.

Uma vez que voc√™ tenha decidido sobre um m√©todo para integrar fontes de dados externas, tamb√©m pode precisar considerar como pr√©-processar e formatar os dados para que possam ser facilmente usados pelo modelo de IA. Isso pode envolver a limpeza dos dados, convert√™-los para um formato adequado (como texto simples ou Markdown), ou dividi-los em peda√ßos menores para facilitar a recupera√ß√£o.

> [!NOTE]
> Ao integrar fontes de dados externas em sua aplica√ß√£o de IA, √© importante considerar as implica√ß√µes de privacidade e seguran√ßa de acessar e armazenar dados. Certifique-se de ter as permiss√µes e salvaguardas necess√°rias para proteger os dados e cumprir com quaisquer regulamentos relevantes.

Se voc√™ estiver usando um banco de dados, tamb√©m deve pensar em como deseja *pesquisar seus dados* para recuperar as informa√ß√µes mais relevantes. Isso pode ser feito usando pesquisa por palavras-chave, pesquisa de texto completo ou t√©cnicas mais avan√ßadas como pesquisa sem√¢ntica ou pesquisa vetorial que podem precisar de indexa√ß√£o espec√≠fica. Cobriremos t√©cnicas avan√ßadas de pesquisa em uma li√ß√£o futura.

**Voc√™**: Pode explicar termos como API e Bancos de Dados em termos mais do s√©culo XIX?

**Ada**: Claro, uma API √© como um mensageiro que entrega uma mensagem de um lugar para outro, e um banco de dados √© como uma biblioteca onde voc√™ guarda todos os seus livros.

**Voc√™**: Ah, entendo, faz sentido.

## Aumentando o prompt

**Ada:** Voc√™ ainda est√° me acompanhando? √ìtimo, vamos para o pr√≥ximo passo, vamos tentar melhorar o prompt enviado ao modelo de IA.

**Ada:** Uma vez que voc√™ tenha configurado uma forma de extrair informa√ß√µes dos seus dados, voc√™ pode adicion√°-las ao prompt do modelo de IA. Basta misturar as informa√ß√µes recuperadas no texto de entrada com algum contexto adicional ou orienta√ß√£o para direcionar a resposta da IA.

Por exemplo, se voc√™ estiver construindo um aplicativo para responder perguntas sobre carros, poderia ter um prompt como o seguinte:

```text

## Instru√ß√µes
Responda perguntas sobre carros usando apenas as fontes abaixo.
Se n√£o houver dados suficientes nas fontes fornecidas, diga que voc√™ n√£o sabe.
Seja breve e direto ao ponto.

## Fontes
<insira aqui as informa√ß√µes recuperadas>

## Pergunta
<insira aqui a pergunta>
```

Ao fornecer ao modelo de IA contexto e informa√ß√µes adicionais, voc√™ pode ajudar a orientar o processo de gera√ß√£o e garantir que as respostas sejam precisas e relevantes para o tema em quest√£o.

> [!TIP]
> Note esta parte do prompt: `Se n√£o houver dados suficientes nas fontes fornecidas, diga que voc√™ n√£o sabe.`. Isso √© importante para evitar que a IA gere informa√ß√µes incorretas quando n√£o h√° dados suficientes para fornecer uma resposta confi√°vel. Esta t√©cnica √© chamada de *rota de fuga* e √© uma boa pr√°tica para garantir a qualidade do conte√∫do gerado.

RAG pode ser considerado como uma forma avan√ßada de *engenharia de prompts*.

### Exemplo de c√≥digo

**Ada:** A pr√°tica leva √† perfei√ß√£o, ent√£o vamos aplicar o que aprendemos com um exemplo. Vamos construir um sistema simples de recupera√ß√£o em um aplicativo JavaScript usando um arquivo [CSV](https://fr.wikipedia.org/wiki/Comma-separated_values) de dados de carros h√≠bridos e um algoritmo de busca b√°sico para extrair informa√ß√µes relevantes com base na pergunta de um usu√°rio.

```javascript
// Este exemplo demonstra como usar a Gera√ß√£o Aumentada por Recupera√ß√£o (RAG)
// para responder perguntas baseadas em um conjunto de dados de carros h√≠bridos.
// O c√≥digo abaixo l√™ o arquivo CSV, busca correspond√™ncias para a pergunta do usu√°rio,
// e ent√£o gera uma resposta baseada nas informa√ß√µes encontradas.

import { fileURLToPath } from 'node:url';
import { dirname } from 'node:path';
import process from "node:process";
import fs from "node:fs";
import { OpenAI } from "openai";

// Muda o diret√≥rio de trabalho atual para o diret√≥rio do script
const __dirname = dirname(fileURLToPath(import.meta.url));
process.chdir(__dirname);

// 1. Fa√ßa uma pergunta sobre carros h√≠bridos
// -----------------------------------

const question = `qual √© o prius mais r√°pido`;

// 2. Componente recuperador: pesquisa os dados por informa√ß√µes relevantes
// ----------------------------------------------------------------

// Carrega dados CSV como um array de objetos
const rows = fs.readFileSync("./hybrid.csv", "utf8").split("\n");
const columns = rows[0].split(",");

// Pesquisa os dados usando uma busca muito ing√™nua
const words = question
  .toLowerCase()
  .replaceAll(/[.?!()'":,]/g, "")
  .split(" ")
  .filter((word) => word.length > 2);
const matches = rows.slice(1).filter((row) => words.some((word) => row.toLowerCase().includes(word)));

// Formata como uma tabela markdown, j√° que modelos de linguagem entendem markdown
const table =
  `| ${columns.join(" | ")} |\n` +
  `|${columns.map(() => "---").join(" | ")}|\n` +
  matches.map((row) => `| ${row.replaceAll(",", " | ")} |\n`).join("");

console.log(`Encontradas ${matches.length} correspond√™ncias:`);
console.log(table);

// 3. Aumento de contexto: cria um prompt combinado com os resultados da pesquisa
// --------------------------------------------------------------------------

const augmentedPrompt = `
## Instru√ß√µes
Responda perguntas sobre um per√≠odo de tempo ou personagens desse per√≠odo usando apenas as fontes abaixo.
Se n√£o houver dados suficientes nas fontes fornecidas, diga que voc√™ n√£o sabe.
Seja breve e direto ao ponto.

## Fontes
${table}

## Pergunta
${question}
`;

// 4. Componente gerador: usa os resultados da pesquisa para gerar uma resposta
// ---------------------------------------------------------------------

const openai = new OpenAI({
  baseURL: "https://models.inference.ai.azure.com",
  apiKey: process.env.GITHUB_TOKEN,
});

const chunks = await openai.chat.completions.create({
  model: "gpt-4o-mini",
  messages: [{ role: "user", content: augmentedPrompt }],
  stream: true,
});

console.log(`Resposta para "${question}":`);

for await (const chunk of chunks) {
  process.stdout.write(chunk.choices[0].delta.content ?? "");
}
```

Voc√™ pode encontrar este c√≥digo no arquivo [`example/rag-cars.js`](../example/rag-cars.js) junto com o arquivo [`hybrid.csv`](../example/hybrid.csv) contendo os dados usados para a recupera√ß√£o.

**Ada:** Uma vez que voc√™ execute este c√≥digo, voc√™ deve ver os dados encontrados no arquivo CSV pelo recuperador, formatados como uma tabela markdown, seguidos pela resposta gerada pela IA para a pergunta. Tente mudar a pergunta para ver como os dados recuperados e a resposta mudam. Voc√™ tamb√©m pode tentar fazer perguntas sobre t√≥picos n√£o relacionados para ver como o modelo de IA lida com eles.

```text
Exemplo da sa√≠da:

Encontradas 1 correspond√™ncias:
| Pessoa | Per√≠odo de Tempo | Descri√ß√£o |
|---|---|---|
| Leonardo Da Vinci | S√©culo XV | Pol√≠mata italiano conhecido por sua arte e inven√ß√µes. |
| Isaac Newton | S√©culo XVII | Matem√°tico e f√≠sico ingl√™s que formulou as leis do movimento e da gravita√ß√£o universal. |
```

**Voc√™:** Isso √© √≥timo, posso ver como isso pode ser √∫til ao usar o dispositivo, ou melhor, como j√° foi ou ser√° √∫til, viagem no tempo √© confusa *suspiro*.

**Ada:** Calma, voc√™ est√° indo muito bem. Vamos passar para o pr√≥ximo passo.

## Tarefa - Ajudando Ada e Charles

Tendo aprendido sobre RAG, voc√™ est√° agora pronto para ajudar Ada e Charles com seu dispositivo. No entanto, ao inspecionar mais de perto, o dispositivo parece familiar.

**Voc√™:** Besouro do Tempo, voc√™ sabe o que √© isso?

**Besouro do Tempo:** Claro, sou eu, ou serei. Estou faltando algumas pe√ßas, pensando bem, estou faltando muitas pe√ßas, nem tenho uma casca ainda.

**Ada:** O Besouro do Tempo √© um dispositivo que permite viajar atrav√©s do tempo e do espa√ßo, isto √©, uma vez que conseguirmos faz√™-lo funcionar corretamente. Como eu estava dizendo, precisamos adicionar um novo recurso a ele, um m√≥dulo de gera√ß√£o aumentada por recupera√ß√£o (RAG). Isso nos ajudar√° a recuperar informa√ß√µes e o contexto necess√°rio de diferentes per√≠odos de tempo enquanto voc√™ viaja. Queremos garantir que consultemos todo tipo de fontes, a Wikipedia √© um bom come√ßo.

**Voc√™:** O que voc√™ precisa que eu fa√ßa?

**Ada:** Aqui est√° um c√≥digo de exemplo que recupera informa√ß√µes de texto sobre Tim Berners-Lee da Wikipedia, Tim ser√° muito importante um dia.

```javascript
const response = await fetch('https://en.wikipedia.org/w/api.php?format=json&action=query&prop=extracts&redirects=true&explaintext&titles=Tim%20Berners-Lee');
const data = await response.json();
const text = Object.values(data.query.pages)[0]?.extract;
```

**Voc√™:** Presumo que n√£o sou o √∫nico que esteve no futuro?

**Ada:** ...

## Solu√ß√£o

[Solu√ß√£o](../solution/rag-www.js)

## Verifica√ß√£o de conhecimento

**Pergunta**: Qual √© o papel do recuperador em um sistema RAG?

A. O recuperador gera respostas com base nos dados de entrada.

B. O recuperador gera informa√ß√µes relevantes com base nos dados de treinamento do modelo.

C. O recuperador encontra informa√ß√µes relevantes de fontes de dados externas.

[Solu√ß√£o do quiz](../solution/solution-quiz.md)

## Recursos para auto-estudo

- [Gera√ß√£o Aumentada por Recupera√ß√£o e √çndices](https://learn.microsoft.com/azure/ai-studio/concepts/retrieval-augmented-generation)
- **Aplicativos de exemplo**:
  * [Chat de IA Serverless com RAG](https://github.com/Azure-Samples/serverless-chat-langchainjs/)
  * [Ask Youtube: Uma API de perguntas e respostas do Youtube baseada em RAG](https://github.com/Azure-Samples/langchainjs-quickstart-demo)
- [Workshop completo: Crie seu pr√≥prio ChatGPT com RAG](https://moaw.dev/workshop/gh:azure-samples/azure-openai-rag-workshop/docs/workshop-qdrant.md)
