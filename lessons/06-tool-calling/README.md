# Lesson 6: Tool calling

Tool calling, or function calling that it's also known as is about providing capabilities to your AI model it didn't have before. The idea is to provide it with meta descriptions of your actual functions and make the AI model point out when such a tool should be called given a user's prompt.

In this chapter, you will learn:

- How to build a tool.
- Integrate a tool with the AI model.
- Call the tool from the AI model.

## Setup

If you haven't already, set up your development environment. Here's how you can do it: [Setup your environment](/docs/setup/README.md).

## Related resources

[![Integrating with function calling](./assets/11-lesson-banner.png?WT.mc_id=academic-105485-koreyst)](https://aka.ms/gen-ai-lesson11-gh?WT.mc_id=academic-105485-koreyst)

_This video explains Tool calling, a method that helps the AI call your functions and thereby expand what it can do_

*ðŸŽ¥ Click on the image above to watch a short video about Tool calling*

## Narrative: Amelia

> _You are a mechanic from 1860s London. While working on your automaton, you received a letter from Charles Babbage that led you to a library, where you picked up a time travel device. Throughout your travels in time, you ended up in Florence, where you met Leonardo da Vinci. You have now met up with Ada Lovelace in her mansion, accompanied by Charles Babbage. They are in the process of constructing the time travel device._
>
> See [Lesson 1](/lessons/01-intro-to-genai/README.md) if you want to catch up with the story from the beginning.

> [!NOTE] 
> While we recommend going through the story (it's fun!), [click here](#interact-with-amelia-earhart) if you'd prefer to jump straight to the technical content.

**Ada Lovelace**: "I need you to go meet a friend of mine. There are few people who can match her expertise in mechanics and problem-solving. It might be hard to catch her, though; she's always on the move :)"

You: "Who are we talking about and where can I find her?"

**Ada Lovelace**: "Why, Amelia Earhart, of course! She's a pilot and adventurer, currently flying around the world. It's totally my fault she's disappearedâ€”I gave her the time travel device, well, an early prototype of it. Luckily, the device you have can locate other devices, so you can find her. All you need to do is click here and here, and then twist this knob."

**You**: "Hey, wait, what's our mission exactly?"

**Ada**: "Oh, right! Ask the device; it has all the details. Just ask it about Amelia, and it should initiate the correct tool for you."

The world around you starts to blur, and everything fades to black. You come to and find yourself in the cockpit of a plane. You're airborne, and you can see the ocean below you. There's someone sitting in front; you can only see the back of their neck.

<div>
    <img src="./assets/amelia.jpeg" alt="Amelia piloting a plane" width="300">
</div>

**You**: "Amelia, is that you?"

**Amelia Earhart**: "Who are you? Let me guess, Ada sent you, right?"

**You**: "Yes, correct. I'm here to help you, I think. Ada wasn't big on specifics."

**Amelia Earhart**: "Well, good thing you're here. I'm in a bit of a pickle. I'm trying to find a place to land, and I'm running out of fuel. Can you help me?"

**You**: "Device, can you tell me more about Amelia?"

**Time Beetle**: "Calling tool: mission-amelia. Tool initiated. Amelia Earhart is a pilot and adventurer. She's known for her record-breaking flights and her disappearance in 1937. She was last seen flying over the Pacific Ocean. She's currently flying around the world in her plane, the Electra. She's running out of fuel and needs to find a place to land."

**You**: "Device, can you help me find a place for Amelia to land?"

**Time Beetle**: "Calling tool: find-landing-spot. Tool initiated. Searching for a suitable landing spot for Amelia Earhart. Please wait. Found a suitable landing spot. Coordinates: 7.5Â°N, 134.5Â°E. Amelia, I have found a suitable landing spot for you. Please head to the coordinates 7.5Â°N, 134.5Â°E."

**Amelia Earhart**: "Thank you! I wish my device had that feature. I'll head there now."

## Interact with Amelia Earhart

If you want to interact with Ada, run the [Characters](/app/README.md) app.

> [!IMPORTANT]
> This is entirely fictional; the responses are generated by AI.
> [Responsible AI disclaimer](/README.md#responsible-ai-disclaimer)

<div>
  <img src="./assets/amelia-front.jpeg" alt="Ada Lovelace" width="300">
</div>

**Steps**:

1. Start a [![GitHub Codespace](https://img.shields.io/badge/GitHub-Codespace-brightgreen)](https://codespaces.new/microsoft/generative-ai-with-javascript)
2. Navigate to _/app_ in the repo root.
3. Locate the console and run `npm install` followed by `npm start`.
4. Once it appears, select the "Open in Browser" button.
5. Chat with Amelia.

For a more detailed explanation of the app, see [Detailed app explanation](/lessons/01-intro-to-genai/README.md#interact-with-dinocrates).

> [!NOTE]
 > If you're running the project locally on your machine, please review the QuickStart guide to get a [GitHub personal access](/docs/setup/README.md#creating-a-personal-access-token-pat-for-github-model-access) token setup and replace the key in the code.

## Tool calling

**You**: "Device, what just happened?"

**Time beetle**: "You just called a tool. A tool is a function that can be called by the AI model to perform a specific task. The tool can be used to perform a wide range of tasks, from simple calculations to complex operations. In this case, you called the `find-landing-spot` tool to help Amelia Earhart find a suitable landing spot."

**Time beetle**: "Here's an image to illustrate the process of tool calling:"

<div>
    <img src="./assets/tool_call_langchain.png" alt="Tool calling process illustration" width="600">
</div>

_Image credit Langchain <https://python.langchain.com/docs/concepts/tool_calling/>_

**You**: "How do I create a tool?"

**Time beetle**: "To create a tool, you need to define a function that performs the desired task. The function should take the necessary inputs and return the output. You can then call the function from the AI model to perform the task. Here's what the `find-landing-spot` tool looks like:

```javascript
function findLandingSpot(lat, long) {
    // Perform the task of finding a suitable landing spot
    // Return the coordinates of the landing spot
    return { lat: 7.5, long: 134.5 };
}
```

**You**: "Ok, how does the AI model know that this tool exists?"

**Time beetle**: "You need to register the tool with the AI model. This tells the model that the tool is available to be called. Let's cover that in the next section."

### Registering a tool

**You**: "You said I need to register the tool with the AI model. How do I do that?"

**Time beetle**: "To register a tool with the AI model, you need to define a metadata representation of the tool. This metadata should include the name of the tool, the input parameters, and the output format. You can then register the tool with the AI model by providing the metadata. Here's an example of the metadata for the `find-landing-spot` tool:

```json
{
  "name": "find-landing-spot",
  "description": "Finds a suitable landing spot",
  "parameters": {
    "type": "object",
    "properties": {
      "lat": {
        "type": "number",
        "description": "The latitude of the location",
      },
      "long": {
        "type": "number",
        "description": "The longitude of the location",
      },
    },
    "required": ["lat", "long"],
  },
  "output": { "type": "object", "properties": { "lat": "number", "long": "number" } }
}
```

**You**: "Ok, so there's a piece of JSON that describes the tool, now what?"

**Time beetle**: "Now, you need to provide that to your client chat completion call like so:

```javascript

function findLandingSpot(lat, long) {
    // Perform the task of finding a suitable landing spot
    // Return the coordinates of the landing spot
    return { lat: 7.5, long: 134.5 };
}

function getBackgroundOnCharacter(character) {
    // Perform the task of getting background information on a character
    // Return the background information
    return `Background information on ${character}`;
}

const getBackgroundOnCharacterJson = {
  name: "get-background-on-character",
  description: "Get background information on a character",
  parameters: {
    type: "object",
    properties: {
      name: {
        type: "string",
        description: "The name of the character",
      }
    },
    required: ["lat", "long"],
  },
  output: { type: "string" }
};

const findLandingSpotJson = {
  name: "find-landing-spot",
  description: "Finds a suitable landing spot",
  parameters: {
    type: "object",
    properties: {
      lat: {
        type: "number",
        description: "The latitude of the location",
      },
      long: {
        type: "number",
        description: "The longitude of the location",
      },
    },
    required: ["lat", "long"],
  },
  output: { type: "object", properties: { lat: "number", long: "number" } }
};


const messages = [{ 
    role: "user", 
    content: `Tell me about Amelia Earhart`,
}];

const completion = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: messages,
    functions: [getBackgroundOnCharacterJson, findLandingSpotJson]
  });
```

**Time beetle**: "In the preceding code snippet we:" 

- Define the metadata for the `find-landing-spot` tool and the `get-background-on-character` tool. 
- Provide this metadata to the `client.getChatCompletions` call as part of the `functions` parameter. This tells the AI model that these tools are available to be called."

**You**: "Got it, so the AI model will call the appropriate if I provide a prompt that matches to the tool's description?"

**Time beetle**: "Almost, it will tell you what tool it thinks you should call and it will provide you with the parsed input parameters, but you need to call the tool yourself, let me show you how."

### Calling a tool

**Time beetle**: "As I was saying, the AI model will tell you what tool it thinks you should call and it will provide you with the parsed input parameters. You then need to call the tool yourself. Here's what the workflow will look like step by step:

1. Wire up the tool call

   First, you need to wire up the tool call in your code. This involves creating the function and a metadata representation of the tool, and then providing the metadata to the AI model.

1. User makes a request via a prompt:
   - Program makes a chat completion request to the AI model with the user prompt and tools metadata provided.
   - Program receives a response from the AI model with the tool call and parsed input parameters if it thinks a tool should be called.
   - If so, the developer interprets the response and calls the tool based on the function call provided by the AI model.

**You**: "Great, now that I understand high level what's going on, can you show me some code?"

**Time beetle**: "Sure, here's the code wire up the tool call, making a chat completion request and interpreting the response:

```javascript
import { OpenAI } from 'openai';
import { maybeCoerceInteger } from 'openai/core.mjs';

// 1: Define the function
function findLandingSpot(lat, long) {
  console.log("[Function] Finding landing spot with coordinates: ", lat, long);
  // Perform the task of finding a suitable landing spot
  // Return the coordinates of the landing spot
  return { lat: 7.5, long: 134.5 };
}

// 2: Define the tool metadata, should include description, parameters, and output
const findLandingSpotJson = {
  name: "find-landing-spot",
  description: "Finds a suitable landing spot",
  parameters: {
    type: "object",
    properties: {
      lat: {
        type: "number",
        description: "The latitude of the location",
      },
      long: {
        type: "number",
        description: "The longitude of the location",
      },
    },
    required: ["lat", "long"],
  },
  output: { type: "object", properties: { lat: "number", long: "number" } }
};

// 3: Add the tool to the tools object that we will use later to invoke the tool
const tools = {
  [findLandingSpotJson.name]: findLandingSpot
};

// 4: Create an instance of the OpenAI client
const openai = new OpenAI({
    baseURL: "https://models.inference.ai.azure.com", // might need to change to this url in the future: https://models.github.ai/inference
    apiKey: process.env.GITHUB_TOKEN,
});

// 5: Define the messages that will be sent to the AI model
const messages = [
{
    role: "system",
    content: `You are a helpful assistant. You can call functions to perform tasks. Make sure to parse the function call and arguments correctly.`
}, {
    role: "user",
    content: "Find a landing spot given coordinates 8.5, 130.5"
}
];

async function main(){
  console.log("Making LLM call")

  // 6: Call the AI model with the defined messages and tools
  const result = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: messages,
      functions: [findLandingSpotJson]
    });

  for (const choice of result.choices) {

      let functionCall = choice.message?.function_call;
      let functionName = functionCall?.name;
      let args = JSON.parse(functionCall?.arguments);

      // 7: Interpret response and call the tool based on the function call provided by the AI model
      if (functionName && functionName in tools) {
          console.log(`Calling [${functionName}]`);
          const toolFunction = tools[functionName];
          const toolResponse = toolFunction(...Object.values(args)); // Extract values from args and spread them
          console.log("Result from [tool] calling: ", toolResponse);
      }
  }
}

main();
```

In the preceding code we've:

- Created a function called `findLandingSpot` that takes latitude and longitude as input and returns the coordinates of a suitable landing spot.
- Defined the metadata for the `find-landing-spot` tool.
- Created a `tools` object that maps tool names to tool metadata.
- Provided the `tools` object to the `client.getChatCompletions` call.

   ```javascript
   if (functionName && functionName in tools) {
    console.log(`Calling [${functionName}]`);
    const toolFunction = tools[functionName];
    const toolResponse = toolFunction(...Object.values(args)); // Extract values from args and spread them
    console.log("Result from [tool] calling: ", toolResponse);
   }
   ```

- Called the tool based on the function call provided by the AI model.
- Printed the result of the tool call.

**You**: "I think I get it. I define a function, create a metadata representation of the tool, provide the metadata to the AI model, and then call the tool based on the function call provided by the AI model."

**Time beetle**: "Exactly! You're ready to start building your own tools and integrating them with the AI model."

## Assignment - upgrade Amelia's time travel device

**Amelia Earhart**: "We're coming down hot, thank God you found us a landing spot. Hold on tight!"

Amelia ends up expertly landing the plane on a small island. You and Amelia step out of the plane, whereby Amelia hands you a small device.

**Amelia Earhart**: "Here's my device, not as fancy as yours but it's got some nifty features. I've been using it to let's say do some time traveling of my own. Can you please upgrade it for me?"

**You**: "Time beetle, can you help me upgrade Amelia's device?"

**Time beetle**: "Of course! To upgrade Amelia's device, let's add the following tools to it:

- **A tool than can**: Calculate the distance between two points on a map.
- **A tool than can**: Figure out the GPS position of where Amelia is currently located.
- **A tool than can**: Call an external API to get the weather forecast for a given location."  

Here are the functions, all you need to do is to register them and test them out:

```javascript
function calculateDistance(lat1, long1, lat2, long2) {
    // Perform the task of calculating the distance between two points
    // Return the distance between the points
    return Math.sqrt((lat2 - lat1) ** 2 + (long2 - long1) ** 2);
}

function getGpsPosition() {
    // Perform the task of getting the GPS position of the current location
    // Return the GPS position
    return { lat: 7.5, long: 134.5 };
}

function getWeatherForecast(lat, long) {
    // Perform the task of getting the weather forecast for a given location
    // Return the weather forecast
    return "Sunny";
}
```

**You**: "Time beetle, are you sure these functions are going to work, looks like they're just returning some random values?"

**Time beetle**: "That's correct, I can do the rest internally. All you need to do is to register them and test them out, make sure the AI model can call them."

> Task: Register the `calculateDistance`, `getGpsPosition`, and `getWeatherForecast` tools with the AI model. Test the tools by calling them from the AI model. Use the code supplied in the previous sections as a reference.

## Solution

[Solution](./solution/solution.js)

## Knowledge check

**Question:**  
What is the purpose of registering a tool with the AI model?

A. To allow the AI model to directly execute the tool without developer intervention.  
B. To provide metadata about the tool so the AI model can suggest its usage.  
C. To replace the need for defining functions in the code.

**Question:**  
What is the role of tool metadata in tool calling?

A. It describes the tool's purpose, inputs, and outputs for the AI model.  
B. It provides the AI model with the tool's implementation details.  
C. It ensures the tool is executed automatically by the AI model.

**Question:**  
Why do tool calling?

A. To enable the AI model to perform tasks beyond its built-in capabilities by leveraging external functions.  
B. To replace the need for human intervention in AI model development.  
C. To allow the AI model to execute tools without requiring metadata.

[Solution quiz](./solution/solution-quiz.md)

## Self-Study resources

- Explains the [process of tool calling](https://learn.microsoft.com/en-us/semantic-kernel/concepts/ai-services/chat-completion/function-calling/?pivots=programming-language-csharp)
- Tool calling in the [framework Langchain](https://js.langchain.com/docs/how_to/tool_calling/)
- Function calling as demonstrated in the [openai library](https://github.com/openai/openai-node/blob/master/examples/function-call.ts)
